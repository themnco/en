<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comet - Account</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.comcom/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- ADDED: Firebase Storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Mono:wght@400&display=swap');
        :root {
            --background: #000000;
            --text-primary: #FFFFFF;
            --text-secondary: #888888;
            --border-color: #333333;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Space Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { background: var(--background); }
        body { color: var(--text-primary); font-family: var(--font-sans); }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 20px; font-weight: 600; }
        .logout-btn { color: var(--text-secondary); text-decoration: none; transition: color 0.2s; }
        .logout-btn:hover { color: var(--text-primary); }
        
        .main-content { max-width: 800px; margin: 60px auto; padding: 0 40px; }
        
        /* --- Profile Picture Section --- */
        .profile-picture-section {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 60px;
        }
        .profile-picture-container {
            position: relative;
            width: 96px;
            height: 96px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #profilePicture {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover; /* Ensures the image covers the circle without distortion */
        }
        .profile-picture-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        .profile-picture-container:hover .profile-picture-overlay {
            opacity: 1;
        }
        .spinner {
            position: absolute;
            top: 50%; left: 50%;
            width: 40px; height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* --- End Profile Picture Section --- */

        .profile-header h1 { font-size: 2.5rem; font-weight: 500; }
        .profile-header p { color: var(--text-secondary); font-family: var(--font-mono); margin-top: 10px; }
        
        .details-list dt { font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        .details-list dd { font-size: 1.2rem; font-family: var(--font-mono); margin-bottom: 30px; }
        .loading { text-align: center; margin-top: 100px; font-size: 1rem; color: var(--text-secondary); }
        .upload-message { color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px; height: 20px; text-align: center;}
    </style>
</head>
<body>
    <main id="profilePage" style="display: none;">
        <nav class="navbar">
            <div class="logo">C</div>
            <a href="4.html" class="logout-btn">Sign Out</a>
        </nav>
        <div class="main-content">
            <section class="profile-picture-section">
                <div class="profile-picture-container" onclick="triggerFileUpload()">
                    <img id="profilePicture" src="" alt="Profile Picture">
                    <div class="profile-picture-overlay">Change</div>
                    <div id="spinner" class="spinner"></div>
                </div>
                <header class="profile-header">
                    <h1 id="nameDisplay"></h1>
                    <p id="cometIdDisplay"></p>
                </header>
            </section>
            
            <!-- Hidden file input -->
            <input type="file" id="fileInput" accept="image/png, image/jpeg" style="display:none;" onchange="uploadProfilePicture(event)">
            <p id="uploadMessage" class="upload-message"></p>

            <dl class="details-list">
                <div> <dt>Date of Birth</dt> <dd id="dobDisplay"></dd> </div>
                <div> <dt>Gender</dt> <dd id="genderDisplay"></dd> </div>
            </dl>
        </div>
    </main>
    <div id="loading" class="loading">Loading account data...</div>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBDHgR4VKaa-c5OcfGDhaLfVlDBkRRWd8k", authDomain: "commet-accounts.firebaseapp.com", projectId: "commet-accounts", storageBucket: "commet-accounts.firebasestorage.app", messagingSenderId: "35074463743", appId: "1:35074463743:web:e11289b56b6fa845e879ca", measurementId: "G-F1N8TTQLMT5" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Firebase Storage

        let currentUserId = null; // To store the user's ID for uploads

        async function loadProfile() {
            const loggedInUserCometId = localStorage.getItem('loggedInUserCometId');
            if (!loggedInUserCometId) { window.location.href = '1.html'; return; }
            
            const idWithoutDomain = loggedInUserCometId.replace('@comet.com', '');
            currentUserId = idWithoutDomain; // Store the ID for later use

            try {
                const userDoc = await db.collection('users').doc(idWithoutDomain).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Populate text fields
                    document.getElementById('nameDisplay').textContent = `${userData.firstName} ${userData.lastName}`;
                    document.getElementById('cometIdDisplay').textContent = userData.cometId;
                    document.getElementById('dobDisplay').textContent = userData.dob;
                    document.getElementById('genderDisplay').textContent = userData.gender;

                    // Set profile picture
                    const profilePicElement = document.getElementById('profilePicture');
                    if (userData.profilePictureUrl) {
                        profilePicElement.src = userData.profilePictureUrl;
                    } else {
                        // Assign a random default picture
                        const randomNumber = Math.floor(Math.random() * 20) + 1;
                        profilePicElement.src = `https://xperts-app.github.io/extensions/cdn/Images/profile/${randomNumber}.jpg`;
                    }

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('profilePage').style.display = 'block';
                } else { 
                    localStorage.removeItem('loggedInUserCometId'); 
                    window.location.href = '1.html'; 
                }
            } catch (error) { 
                document.getElementById('loading').textContent = 'Error loading data.'; 
            }
        }

        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        async function uploadProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Simple validation
            if (!file.type.startsWith('image/')) {
                document.getElementById('uploadMessage').textContent = 'Error: Invalid file type.';
                return;
            }

            const spinner = document.getElementById('spinner');
            const uploadMessage = document.getElementById('uploadMessage');
            
            spinner.style.display = 'block';
            uploadMessage.textContent = 'Uploading...';

            const filePath = `profile_pictures/${currentUserId}`;
            const fileRef = storage.ref(filePath);

            try {
                const snapshot = await fileRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // Update Firestore with the new URL
                await db.collection('users').doc(currentUserId).update({
                    profilePictureUrl: downloadURL
                });

                // Update the image on the page
                document.getElementById('profilePicture').src = downloadURL;
                uploadMessage.textContent = 'Upload complete.';
                
            } catch (error) {
                console.error("Upload failed:", error);
                uploadMessage.textContent = 'Upload failed. Please try again.';
            } finally {
                spinner.style.display = 'none';
                // Clear the message after a few seconds
                setTimeout(() => { uploadMessage.textContent = ''; }, 3000);
            }
        }

        window.onload = loadProfile;
    </script>
</body>
</html>
